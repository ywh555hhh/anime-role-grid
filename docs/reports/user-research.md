# 图片保存功能调查报告

## 1. 问题现象
用户反馈在点击“保存高清图片”后，弹出了“保存成功”的提示，但实际上图片并未下载到本地。该现象在 QQ 内置浏览器等 App 内嵌网页（WebView）中尤为明显。

## 2. 原因分析

### 2.1 "假成功" 的技术原理
目前的保存逻辑 (`src/App.vue` 和 `src/logic/export.ts`) 如下：
1.  **生成图片**: 使用 Canvas 生成图片的 Base64 数据 (`data:image/png;base64,...`)。
2.  **触发下载**:
    *   **iOS**: 识别到 iOS 环境，打开新窗口显示图片（因为 iOS Safari 对 `download` 属性支持不佳）。
    *   **其他 (Android/PC)**: 创建一个隐藏的 `<a>` 标签，设置 `download` 属性，并程序化调用 `.click()` 方法。
3.  **显示成功**: `exportGridAsImage` 函数执行完毕且未报错，`App.vue` 随即显示“保存成功”弹窗。

**核心问题**: `<a>` 标签的 `.click()` 方法是“触发即忘” (fire-and-forget) 的。浏览器**不会**告诉 JavaScript 下载是否真的开始了，或者是否被拦截了。代码只要成功触发了点击事件，就认为“成功”了，从而弹出了误导性的提示。

### 2.2 QQ/微信等 WebView 的限制
*   **拦截下载**: 许多 App 的内置浏览器（如 QQ、微信）出于安全或体验考虑，会拦截非标准的下载行为，特别是 `data:` 协议的链接下载。
*   **不支持 `download` 属性**: 这些浏览器可能完全忽略 `<a>` 标签的 `download` 属性，导致点击无效，或者尝试导航到该 Base64 URL 但失败。
*   **无反馈**: 由于上述拦截通常发生在浏览器底层，网页端的 JavaScript 无法捕获到任何错误，导致代码误判为成功。

## 3. 解决方案建议

为了彻底解决“假成功”和兼容性问题，建议统一修改保存流程，不再依赖不稳定的自动下载，而是**显式展示图片供用户保存**。

### 方案 A: 统一使用“预览保存”模式 (推荐)
无论在 PC 还是 移动端（特别是检测到移动端时），点击保存后：
1.  生成图片。
2.  **不自动触发下载**。
3.  弹出一个专门的“图片预览弹窗”（类似现在的“保存成功”弹窗，但内容不同）。
4.  弹窗中直接展示生成的**完整高清图片**。
5.  提示文案修改为：“**请长按图片保存**” (移动端) 或 “**右键另存为**” (PC)。

**优点**:
*   **100% 兼容**: 所有浏览器都支持显示图片，用户手动保存是最可靠的。
*   **所见即所得**: 用户能确认图片已生成。
*   **消除误导**: 不再提示“已保存”，而是引导用户“去保存”。

### 方案 B: 特定环境优化
保留 PC 端的自动下载，仅针对移动端或特定 App (QQ/WeChat) 启用方案 A。

**建议**: 考虑到移动端用户占比高且环境复杂，建议优先实施 **方案 A**，或者至少在所有移动端设备上实施方案 A。

## 4. 后续行动计划
1.  修改 `src/logic/export.ts`，移除 iOS 特判，改为返回生成的 Data URL，而不是在内部处理下载。
2.  修改 `src/App.vue`，在 `handleSave` 获取到 Data URL 后，将其传递给“保存成功”弹窗。
3.  改造“保存成功”弹窗：
    *   显示生成的图片（目前只显示了占位图或 logo）。
    *   修改文案为引导式文案（“请长按保存”）。
