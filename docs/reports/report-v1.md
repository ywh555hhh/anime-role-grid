# 项目升级分析报告

## 1. 当前现状分析
目前的 `anime-role-grid` 项目处于“玩具项目”阶段，主要存在以下问题：
- **核心功能不稳定**：图片导出功能（`html-to-image`）在多端（尤其是移动端和 iOS）表现不佳，经常出现空白、崩溃或样式错乱。
- **代码健壮性不足**：缺乏完善的错误处理机制，用户遇到问题时只能看到简单的报错或无反应。
- **架构简单**：主要逻辑堆砌在 `App.vue` 中，缺乏清晰的模块划分。

## 2. 导出功能失效原因深度分析
经过代码审查，目前的导出逻辑 (`src/logic/export.ts`) 存在以下致命缺陷：
1.  **依赖库限制**：`html-to-image` (以及类似的 `html2canvas`) 依赖于浏览器对 DOM 的解析和 SVG 序列化。这在处理跨域图片、复杂 CSS 属性（如阴影、圆角、Grid 布局）以及自定义字体时，经常出现兼容性问题。
2.  **移动端内存限制**：在移动端（特别是 iOS Safari）上，生成高分辨率的大图容易触发浏览器的内存限制，导致页面崩溃或生成空白图片。目前的 `pixelRatio` 降级处理（移动端设为 2）只是治标不治本。
3.  **DOM 渲染时机**：依赖于一个“隐藏的 DOM 元素”进行截图。如果该元素未完全渲染（例如图片未加载完成、字体未生效），截图就会失败。`setTimeout` 等待是一种不稳定的做法。

## 3. 升级方案：迈向生产级应用

为了将项目升级为“可投入使用”的好项目，我们需要进行彻底的重构，核心策略如下：

### 3.1 核心重构：手写 Canvas 渲染引擎 (The "Pro" Way)
抛弃 `html-to-image` / `html2canvas` 等截图库，改用 **原生 HTML5 Canvas API** 手动绘制导出图片。
-   **优势**：
    -   **100% 可控**：完全控制每一个像素的渲染，确保水印、文字、图片位置分毫不差。
    -   **性能极佳**：直接操作位图，无需 DOM 序列化，内存占用低，速度快。
    -   **兼容性无敌**：Canvas API 是所有现代浏览器（包括 iOS Safari）都完美支持的标准，不存在 CSS 解析差异。
    -   **跨域友好**：可以更好地控制图片加载和 CORS 处理。

### 3.2 架构优化
-   **逻辑抽离**：将 Canvas 绘制逻辑封装为独立的 `ImageGenerator` 类，与 UI 组件解耦。
-   **资源预加载**：建立资源管理模块，确保所有图片、字体在绘制前已就绪。

### 3.3 视觉与体验保留
-   **外观复刻**：在 Canvas 中精确复刻现有的 Grid 布局、字体样式、圆角和阴影。
-   **水印保留**：在绘制流程的最后一步，强制绘制水印，确保无法被简单移除。

## 4. 执行计划
1.  **原型验证**：编写一个纯 Canvas 的绘制函数，尝试绘制一个简单的 Grid Item。
2.  **全量迁移**：实现完整的 Canvas 绘制逻辑，支持动态行列数。
3.  **多端测试**：在 iOS、Android、PC Chrome/Firefox 上进行实测。

此方案将彻底解决“导出失效”的问题，并将项目的技术底座提升到一个新的层次。
