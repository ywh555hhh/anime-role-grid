# 图片生成逻辑说明文档

本文档详细说明了 `src/logic/canvasDraw.ts` 中用于生成导出图片的绘制逻辑。

核心类：`CanvasGenerator`
绘制入口：`generate(options: DrawOptions)`

## 1. 整体布局

画布的高度计算公式：
`总高度 = 标题区域(160px) + 表格高度 + 水印区域(60px) + 上下边距(60px * 2)`

绘制顺序：
1.  **背景填充**：白色 (`#ffffff`)
2.  **标题绘制**：`drawTitle`
3.  **图片预加载**：`loadImage` (并发加载所有角色图片)
4.  **表格内容绘制**：`drawCellContent` (第一遍循环)
5.  **表格边框绘制**：`drawCellBorders` (第二遍循环，确保边框压在内容之上)
6.  **外边框绘制**：整个表格的外围边框
7.  **水印绘制**：`drawWatermark`

---

## 2. 详细绘制逻辑

### 2.1 标题区域 (Title)
-   **代码位置**：`drawTitle` 方法
-   **数据来源**：
    -   **主标题**：来自用户输入 (`customTitle`)，如果为空则默认为 "我的动漫人物喜好果然有问题"。
    -   **副标题**：来自模板配置 (`template.name`)，例如 "经典 (5x3)"。
-   **样式**：
    -   主标题：**60px** 粗体，居中，黑色。
    -   副标题：**32px** 粗体，居中，强调色 (`#e4007f`)，位于主标题下方。

### 2.2 表格区域 (Grid)

表格分为**内容**和**边框**两次绘制，以解决边框被覆盖或粗细不均的问题。

#### A. 内容绘制 (`drawCellContent`)
对于每一个格子：
1.  **图片区域**：
    -   计算图片显示区域（单元格高度 - 标签高度）。
    -   如果存在角色图片：
        -   使用 `clip()` 裁剪绘制区域。
        -   模拟 `object-fit: cover` 效果：计算缩放比例，保持图片比例填充整个区域，居中裁剪。
    -   如果无图片：填充白色背景。
2.  **标签区域**：
    -   在图片下方绘制白色背景矩形。
    -   **文字**：绘制标签文本（如 "本命"），**32px** 粗体，居中。

#### B. 边框绘制 (`drawCellBorders`)
为了保证表格线粗细均匀（**4px**），逻辑如下：
-   **标签顶部分割线**：每个格子都画。
-   **右边框**：只有**非最后一列**的格子才画。
-   **下边框**：只有**非最后一行**的格子才画。
-   **外边框**：在循环结束后，单独绘制一个包围整个表格的大矩形边框。

### 2.3 水印区域 (Watermark)
-   **代码位置**：`drawWatermark` 方法
-   **位置**：画布右下角。
-   **内容**：
    -   Logo 图标 (`/logo.png`)。
    -   文本 "【我推的格子】"，其中 "的" 字使用强调色 (`#e4007f`)。
-   **逻辑**：
    -   先计算文本宽度。
    -   尝试加载 Logo，如果加载成功则绘制 Logo + 文本。
    -   如果 Logo 加载失败，则降级只绘制文本。

## 3. 关键参数配置

在 `src/logic/canvasDraw.ts` 顶部的常量定义了视觉风格：

```typescript
const CELL_WIDTH = 300           // 单元格宽度 (高分辨率)
const BORDER_WIDTH = 4           // 边框粗细
const FONT_FAMILY = '"Noto Serif SC", serif' // 字体
const COLORS = {
    bg: '#ffffff',
    border: '#000000',
    text: '#000000',
    accent: '#e4007f',   // 强调色 (粉色)
    watermark: '#000000'
}
```

如需修改图片外观（如颜色、间距、字体大小），请直接修改这些常量或对应的绘制方法。
